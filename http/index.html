<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Info center</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik:300,400,500">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,600,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="framework/material-components-web.css" />
</head>
<body class="mdc-typography">
<div class="cards">
    <div class="sensors-row">
        <div class="weather-card mdc-elevation--z10">
            <div class="sensor-card-caption">
                <span class="card-label">Kitchen</span>
                <div>
                    <span class="battery-icon material-icons" id="kitchen-connection-bar">filter_1</span>
                    <span class="battery-icon material-icons" id="kitchen-battery-bar">battery_3_bar</span>
                </div>
            </div>
            <div class="displays-container">
                <div>
                    <div>
                        <span class="measure-icon material-symbols-sharp">device_thermostat</span>
                        <span class="weather-primary-value" id="kitchen-temp-value">+17.1&deg;</span>
                    </div>
                    <div>
                        <span class="measure-icon material-symbols-sharp">humidity_mid</span>
                        <span class="weather-primary-value" id="kitchen-hum-value">&nbsp;46.2%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="weather-card mdc-elevation--z10">
            <div class="sensor-card-caption">
                <span class="card-label">Bedroom</span>
                <div>
                    <span class="battery-icon material-icons" id="bedroom-connection-bar">library_add_check</span>
                    <span class="battery-icon material-icons" id="bedroom-battery-bar">battery_3_bar</span>
                </div>
            </div>
            <div class="displays-container">
                <div>
                    <div>
                        <span class="measure-icon material-symbols-sharp">device_thermostat</span>
                        <span class="weather-primary-value" id="bedroom-temp-value">+17.1&deg;</span>
                    </div>
                    <div>
                        <span class="measure-icon material-symbols-sharp">humidity_mid</span>
                        <span class="weather-primary-value" id="bedroom-hum-value">&nbsp;46.2%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="weather-card mdc-elevation--z10">
            <div class="sensor-card-caption">
                <span class="card-label">Balcony</span>
                <div>
                    <span class="battery-icon material-icons" id="balcony-connection-bar">filter_9_plus</span>
                    <span class="battery-icon material-icons" id="balcony-battery-bar">battery_3_bar</span>
                </div>
            </div>
            <div class="displays-container">
                <div>
                    <div>
                        <span class="measure-icon material-symbols-sharp">device_thermostat</span>
                        <span class="weather-primary-value" id="balcony-temp-value">+17.1&deg;</span>
                    </div>
                    <div>
                        <span class="measure-icon material-symbols-sharp">humidity_mid</span>
                        <span class="weather-primary-value" id="balcony-hum-value">&nbsp;46.2%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="weather-row">
        <div class="weather-card mdc-elevation--z10">
            <div class="sensor-card-caption">
                <span class="card-label">Now</span>
            </div>
            <div class="weather-container">
                <div class="weather-main-row">
                    <div class="weather-img-container">
                        <img class="weather-img" id="now-img" src="img/weather/64x64/day/359.png" alt="icon">
                    </div>
                    <div>
                        <div>
                            <span class="measure-icon material-symbols-sharp">device_thermostat</span>
                            <span class="weather-primary-value" id="now-temp-value">+17&deg;</span>
                        </div>
                        <div>
                            <span class="measure-icon material-symbols-sharp">humidity_mid</span>
                            <span class="weather-primary-value" id="now-hum-value">&nbsp;46%</span>
                        </div>
                    </div>
                </div>
                <div class="weather-secondary-row">
                    <div class="weather-secondary-row-cols">
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">compress</span>
                            <span class="weather-secondary-value" id="now-pressure-value">765</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp" id="now-wind-direction">north_west</span>
                            <span class="weather-secondary-value" id="now-wind-value">7</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">cloud</span>
                            <span class="weather-secondary-value" id="now-cloud-value">73%</span>
                        </div>
                    </div>
                    <div class="weather-secondary-row-cols">
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">compress</span>
                            <span class="weather-secondary-value" id="pressure-value">764</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">water</span>
                            <span class="weather-secondary-value" id="now-precipitation-value">7.3 mm</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">sunny</span>
                            <span class="weather-secondary-value" id="now-uv-value">4</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="weather-card mdc-elevation--z10">
            <div class="sensor-card-caption">
                <span class="card-label">Today</span>
            </div>
            <div class="weather-container">
                <div class="weather-main-row">
                    <div class="weather-img-container">
                        <img class="weather-img" id="today-img" src="img/weather/64x64/day/359.png" alt="icon">
                    </div>
                    <div>
                        <div>
                            <span class="measure-icon material-symbols-sharp">device_thermostat</span>
                            <span class="weather-primary-value" id="today-temp-value">+24&deg;</span>
                        </div>
                        <div>
                            <span class="measure-icon material-symbols-sharp">humidity_mid</span>
                            <span class="weather-primary-value" id="today-hum-value">&nbsp;46%</span>
                        </div>
                    </div>
                </div>
                <div class="weather-secondary-row">
                    <div class="weather-secondary-row-cols">
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">thermometer_add</span>
                            <span class="weather-secondary-value" id="today-temp-max-value">+24&deg;</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">air</span>
                            <span class="weather-secondary-value" id="today-wind-value">7</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">rainy_light</span>
                            <span class="weather-secondary-value" id="today-rain-percent-value">5%</span>
                        </div>
                    </div>
                    <div class="weather-secondary-row-cols">
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">thermometer_minus</span>
                            <span class="weather-secondary-value" id="today-temp-min-value">+17&deg;</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">water</span>
                            <span class="weather-secondary-value" id="today-precipitation-value">7.3 mm</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">snowing</span>
                            <span class="weather-secondary-value" id="today-snow-percent-value">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="weather-card mdc-elevation--z10">
            <div class="sensor-card-caption">
                <span class="card-label">Tomorrow</span>
            </div>
            <div class="weather-container">
                <div class="weather-main-row">
                    <div class="weather-img-container">
                        <img class="weather-img" id="tomorrow-img" src="img/weather/64x64/day/359.png" alt="icon">
                    </div>
                    <div>
                        <div>
                            <span class="measure-icon material-symbols-sharp">device_thermostat</span>
                            <span class="weather-primary-value" id="tomorrow-temp-value">+24&deg;</span>
                        </div>
                        <div>
                            <span class="measure-icon material-symbols-sharp">humidity_mid</span>
                            <span class="weather-primary-value" id="tomorrow-hum-value">&nbsp;46%</span>
                        </div>
                    </div>
                </div>
                <div class="weather-secondary-row">
                    <div class="weather-secondary-row-cols">
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">thermometer_add</span>
                            <span class="weather-secondary-value" id="tomorrow-temp-max-value">+24&deg;</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">air</span>
                            <span class="weather-secondary-value" id="tomorrow-wind-value">7</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">rainy_light</span>
                            <span class="weather-secondary-value" id="tomorrow-rain-percent-value">5%</span>
                        </div>
                    </div>
                    <div class="weather-secondary-row-cols">
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">thermometer_minus</span>
                            <span class="weather-secondary-value" id="tomorrow-temp-min-value">+17&deg;</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">water</span>
                            <span class="weather-secondary-value" id="tomorrow-precipitation-value">7.3 mm</span>
                        </div>
                        <div>
                            <span class="measure-secondary-icon material-symbols-sharp">snowing</span>
                            <span class="weather-secondary-value" id="tomorrow-snow-percent-value">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="reset-button-wrapper" class="mdc-touch-target-wrapper">
    <button id="reset-button" class="mdc-fab mdc-fab--mini mdc-fab--touch">
        <div class="mdc-fab__ripple"></div>
        <span class="material-icons mdc-fab__icon">settings_backup_restore</span>
        <div class="mdc-fab__touch"></div>
    </button>
</div>

<div id="error-snackbar" class="mdc-snackbar">
    <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
        <div class="mdc-snackbar__label" aria-atomic="false">
            error text
        </div>
        <div class="mdc-snackbar__actions" aria-atomic="true">
            <button id="error-snackbar-dismiss" class="mdc-icon-button mdc-snackbar__dismiss material-icons" title="Dismiss">close</button>
        </div>
    </div>
</div>
<script src="framework/material-components-web.js"></script>
<script>
    // TODO: 'fetch' error handling with try/catch
    const updateInterval=5000;
    let timeoutId = null;
    let autoUpdateEnabled = true;

    mdc.autoInit();
    const errorBar = new mdc.snackbar.MDCSnackbar(document.querySelector('#error-snackbar'));

    const kitchenTemp = document.querySelector('#kitchen-temp-value');
    const kitchenHum = document.querySelector('#kitchen-hum-value');
    const kitchenBatteryBar = document.querySelector('#kitchen-battery-bar');
    const kitchenConnectionBar = document.querySelector('#kitchen-connection-bar');

    const bedroomTemp = document.querySelector('#bedroom-temp-value');
    const bedroomHum = document.querySelector('#bedroom-hum-value');
    const bedroomBatteryBar = document.querySelector('#bedroom-battery-bar');
    const bedroomConnectionBar = document.querySelector('#bedroom-connection-bar');

    const balconyTemp = document.querySelector('#balcony-temp-value');
    const balconyHum = document.querySelector('#balcony-hum-value');
    const balconyBatteryBar = document.querySelector('#balcony-battery-bar');
    const balconyConnectionBar = document.querySelector('#balcony-connection-bar');

    const nowImg = document.querySelector('#now-img');
    const nowTemp = document.querySelector('#now-temp-value');
    const nowHum = document.querySelector('#now-hum-value');
    const nowPressure = document.querySelector('#now-pressure-value');
    const pressure = document.querySelector('#pressure-value');
    const nowWind = document.querySelector('#now-wind-value');
    const nowWindDir = document.querySelector('#now-wind-direction');
    const nowPrecipitation = document.querySelector('#now-precipitation-value');
    const nowCloud = document.querySelector('#now-cloud-value');
    const nowUV = document.querySelector('#now-uv-value');

    const todayImg = document.querySelector('#today-img');
    const todayTemp = document.querySelector('#today-temp-value');
    const todayHum = document.querySelector('#today-hum-value');
    const todayTempMax = document.querySelector('#today-temp-max-value');
    const todayTempMin = document.querySelector('#today-temp-min-value');
    const todayWind = document.querySelector('#today-wind-value');
    const todayPrecipitation = document.querySelector('#today-precipitation-value');
    const todayRainPercent = document.querySelector('#today-rain-percent-value');
    const todaySnowPercent = document.querySelector('#today-snow-percent-value');

    const tomorrowImg = document.querySelector('#tomorrow-img');
    const tomorrowTemp = document.querySelector('#tomorrow-temp-value');
    const tomorrowHum = document.querySelector('#tomorrow-hum-value');
    const tomorrowTempMax = document.querySelector('#tomorrow-temp-max-value');
    const tomorrowTempMin = document.querySelector('#tomorrow-temp-min-value');
    const tomorrowWind = document.querySelector('#tomorrow-wind-value');
    const tomorrowPrecipitation = document.querySelector('#tomorrow-precipitation-value');
    const tomorrowRainPercent = document.querySelector('#tomorrow-rain-percent-value');
    const tomorrowSnowPercent = document.querySelector('#tomorrow-snow-percent-value');

    const resetButton = document.querySelector('#reset-button')
    new mdc.ripple.MDCRipple(resetButton);
    resetButton.addEventListener('click', _ => {
        reset()
    })

    updateStatus();
    updateWeather();
    enableStatusUpdate();

    function enableStatusUpdate() {
        if (!autoUpdateEnabled) {
            return
        }

        timeoutId = setTimeout(autoUpdateStatus, updateInterval);

        function autoUpdateStatus() {
            updateStatus();
            updateWeather();
            timeoutId = setTimeout(autoUpdateStatus, updateInterval);
        }
    }

    function disableStatusUpdate() {
        if (timeoutId != null) {
            clearTimeout(timeoutId);
        }
    }

    async function reset() {
        const request = new Request(
            '/reset',
            {
                method: 'POST',
            }
        );

        const response = await fetch(request);
        if (!response.ok) {
            showResponseError('Failed to reset', response);
        }
    }

    async function getStatus() {
        const request = new Request(
            '/sensors', { method: 'GET' }
        );

        const response = await fetch(request);
        if (!response.ok) {
            showResponseError('Failed to get status', response);
            return null;
        }

        return await response.json()
    }

    async function getWeather() {
        const request = new Request(
            '/weather', { method: 'GET' }
        );

        const response = await fetch(request);
        if (!response.ok) {
            showResponseError('Failed to get weather', response);
            return null;
        }

        return await response.json()
    }

    function updateStatus() {
        getStatus().then(status => {
            if (status == null) {
                return;
            }

            const kitchenSensorSID = "158d0001fd4989";
            const bedroomSensorSID = "158d000247d48b";
            const balconySensorSID = "158d0001f57fee";

            for (const sensorKey in status) {
                let sensor = status[sensorKey];

                if (sensor.sid == null) {
                    continue;
                }

                switch (sensor.sid) {
                    case kitchenSensorSID:
                        updateThermometer(sensor, kitchenTemp, kitchenHum, kitchenBatteryBar, kitchenConnectionBar);
                        break;
                    case bedroomSensorSID:
                        updateThermometer(sensor, bedroomTemp, bedroomHum, bedroomBatteryBar, bedroomConnectionBar);
                        updatePressure(sensor, pressure);
                        break;
                    case balconySensorSID:
                        updateThermometer(sensor, balconyTemp, balconyHum, balconyBatteryBar, balconyConnectionBar);
                        break;
                }
            }
        });
    }

    function updateWeather() {
        getWeather().then(weather => {
            if (weather == null) {
                return;
            }

            const now = weather.current;
            const today = weather.forecast[0];
            const tomorrow = weather.forecast[1];

            nowImg.src = now.condition_image;
            nowTemp.innerHTML = weatherTemp(now.temperature);
            nowHum.innerHTML = weatherHum(now.humidity);
            nowPressure.innerHTML = Math.round(now.pressure);
            nowWind.innerHTML = Math.round(now.wind);
            nowWindDir.innerHTML = windDirection(now.wind_degree);
            nowPrecipitation.innerHTML = now.precipitation;
            nowCloud.innerHTML = now.cloud_percent + '%';
            nowUV.innerHTML = now.uv;

            todayImg.src = today.condition_image;
            todayTemp.innerHTML = weatherTemp(today.avg_temp);
            todayHum.innerHTML = weatherHum(today.avg_humidity);
            todayTempMax.innerHTML = weatherTemp(today.max_temp);
            todayTempMin.innerHTML = weatherTemp(today.min_temp);
            todayWind.innerHTML = Math.round(today.max_wind);
            todayPrecipitation.innerHTML = today.total_precipitation;
            todayRainPercent.innerHTML = today.daily_chance_of_rain + '%';
            todaySnowPercent.innerHTML = today.daily_chance_of_snow + '%';

            tomorrowImg.src = tomorrow.condition_image;
            tomorrowTemp.innerHTML = weatherTemp(tomorrow.avg_temp);
            tomorrowHum.innerHTML = weatherHum(tomorrow.avg_humidity);
            tomorrowTempMax.innerHTML = weatherTemp(tomorrow.max_temp);
            tomorrowTempMin.innerHTML = weatherTemp(tomorrow.min_temp);
            tomorrowWind.innerHTML = Math.round(tomorrow.max_wind);
            tomorrowPrecipitation.innerHTML = tomorrow.total_precipitation;
            tomorrowRainPercent.innerHTML = tomorrow.daily_chance_of_rain + '%';
            tomorrowSnowPercent.innerHTML = tomorrow.daily_chance_of_snow + '%';
        });
    }

    function windDirection(windDegree) {
        const pseudoAngle = (windDegree + ((360/8)/2)) % 360;
        const val =  Math.floor(pseudoAngle / 45);
        const arr = ["north", "north_east", "east", "south_east","south","south_west","west","north_west"];
        return arr[val]
    }

    function weatherTemp(tempVal) {
        let roundVal = Math.round(tempVal);
        let sign = '+';
        if (roundVal < 0) {
            sign = '';
        } else if (roundVal === 0) {
            sign = '&nbsp;';
        }

        return sign + roundVal + '&deg;';
    }

    function weatherHum(humVal) {
	let hum = Math.round(humVal);
	if (hum > 99) {
	    hum = 99;
	} else if (hum < 0) {
	    hum = 0;
	}

        return '&nbsp;' + hum + '%';
    }

    function formatDecimal(data) {
        return parseFloat(data).toLocaleString(
            'en-US', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1,
            }
        )
    }

    function updateThermometer(thermometer, tempLabel, humidityLabel, batteryBar, connectionBar) {
        if (thermometer === undefined) {
            return;
        }

        const temp = thermometer.temperature;
        if (temp !== undefined) {
            let sign = '+';
            if (temp < 0) {
                sign = '';
            } else if (temp === 0) {
                sign = '&nbsp;';
            }

            tempLabel.innerHTML = sign + formatDecimal(temp)+'&deg;';
        }

        const hum = thermometer.humidity;
        if (hum !== undefined) {
            humidityLabel.innerHTML = '&nbsp;' + formatDecimal(hum) + '%';
        }

        const bat = thermometer.battery_percent;
        if (bat !== undefined) {
            // we have 8 different value bars (0=0_bar 7=full)
            let bar = Math.round(bat*8/100)

            let val
            if (bar >= 7) {
                val = "battery_full";
            } else if (bar < 0) {
                val = "battery_0_bar";
            } else {
                val = `battery_${bar}_bar`;
            }

            batteryBar.innerHTML = val;
        }

        const lastUpdate = thermometer.last_update_sec;
        if (lastUpdate !== undefined) {
            let val = Math.trunc(lastUpdate / 60);
            let valStr
            if (val <= 0) {
                val = "library_add_check"
            } else if (val > 9) {
                val = "filter_9_plus"
            } else {
                val = `filter_${val}`;
            }

            connectionBar.innerHTML = val;
        }
    }

    function updatePressure(sensor, pressureLabel) {
        if (sensor === undefined) {
            return;
        }

        const pressure = sensor.pressure;
        if (pressure !== undefined) {
            pressureLabel.innerHTML = Math.round(pressure / 133.3223684);
        }
    }

    function showError(errorText) {
        errorBar.labelText = errorText;
        errorBar.open()
    }

    function showResponseError(errorText, response) {
        errorBar.labelText = errorText + ": " + response.status + " " + response.statusText;
        errorBar.open()
    }
</script>
</body>
</html>
